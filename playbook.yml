---
- hosts: localhost
  become : yes
  vars:
    grafana_port: 3004
    loki_port : 3100

  tasks:
  - name: Install Grafana
    apt :
      name : apt-transport-https
  
  - apt :
      name : software-properties-common
  
  - shell : wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
  - shell : echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
  
  - name : "Install grafana"
    apt :
      name : grafana
      update_cache : yes
    register: output
  - debug : 
      var : output



  - debug :
      var : output

  - name : Replace default grafana config
    shell : cat configs/grafana_custom_config.ini > /etc/grafana/grafana.ini

  
  - name : Enable Grafana as a servcie
    command : systemctl enable grafana-server.service

  - name : Start Grafana server 
    command : service grafana-server start

  - name : Download promtail and loki
    shell: wget https://github.com/grafana/loki/releases/download/v2.2.1/promtail-linux-amd64.zip && wget https://github.com/grafana/loki/releases/download/v2.2.1/loki-linux-amd64.zip
    args : 
      chdir : /usr/local/bin
    register : output

  - debug : 
      var : output

  - name : Unzip loki and make it executable
    args : 
      chdir : /usr/local/bin
    shell: unzip loki-linux-amd64.zip && chmod a+x loki-linux-amd64.zip
    args : 
      chdir : /usr/local/bin
    register : output

  - debug : 
      var : output

  - name : Unzip promtails and make it executable
    shell : unzip promtail-linux-amd64.zip && chmod a+x promtail-linux-amd64.zip
    args : 
      chdir : /usr/local/bin
    register : output

  - name : Copy Configurations
    copy : 
      src: ./configs/loki-local-config.yaml 
      dest : /usr/local/bin/loki-local-config.yml 
      
  - copy :
      src : configs/promtail-local-config.yaml
      dest :  /usr/local/bin/promtail-local-config.yml

  - copy : 
      src : ./configs/loki.service
      dest : /etc/systemd/system/loki.service
    
  - copy : 
      src : ./configs/promtail.service
      dest : /etc/systemd/system/promtail.service

  - name : Enable loki and promtail at startup
    shell : systemctl enable loki.service && systemctl enable promtail.service
    register : output
    

  - debug : 
      var :  output

  - name : Start loki and promtails
    shell : service promtail start && service loki start
    register : output
    
  - debug : 
      var :  output

    
  
  
  
  

  




